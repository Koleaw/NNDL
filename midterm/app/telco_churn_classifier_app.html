<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Telco Churn Classifier — TensorFlow.js (Browser, v4)</title>
  <!-- libs -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.20.0/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-vis@1.5.1/dist/tfjs-vis.umd.min.js"></script>
  <style>
    :root{--bg:#0f1229;--card:#161a34;--border:#2a2f52;--text:#e7ebff;--muted:#a8b0d9}
    *{box-sizing:border-box}
    body{margin:0;background:radial-gradient(1200px 800px at 15% -10%,#1b2156,var(--bg));color:var(--text);
         font:15px/1.5 system-ui,-apple-system,Segoe UI,Inter,Roboto,Arial,sans-serif}
    .wrap{max-width:1200px;margin:24px auto 96px;padding:0 16px}
    header{display:flex;gap:14px;align-items:center;margin-bottom:16px}
    .logo{width:42px;height:42px;border-radius:12px;background:linear-gradient(135deg,#65b3ff,#a855f7);
          display:flex;align-items:center;justify-content:center;color:#fff;font-weight:800}
    h1{margin:0;font-size:20px}
    .muted{color:var(--muted)}
    .grid{display:grid;gap:14px;grid-template-columns:repeat(12,minmax(0,1fr))}
    .card{grid-column:span 12;background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,.01));
          border:1px solid var(--border);border-radius:16px;padding:14px}
    .cols-6{grid-column:span 6}
    .btn{appearance:none;border:1px solid var(--border);background:rgba(255,255,255,.03);color:var(--text);
         border-radius:12px;padding:8px 12px;cursor:pointer}
    input[type="number"],input[type="text"],select{background:rgba(255,255,255,.03);border:1px solid var(--border);
         border-radius:10px;color:var(--text);padding:6px 8px}
    .pill{display:inline-block;border:1px solid var(--border);border-radius:999px;padding:4px 10px;color:var(--muted);
         background:rgba(255,255,255,.03)}
    .table-wrap{overflow-x:auto;border:1px solid var(--border);border-radius:10px}
    table{width:max-content;min-width:100%;border-collapse:collapse;table-layout:fixed;white-space:nowrap;font-size:13px}
    th,td{padding:6px 10px;border-bottom:1px solid var(--border)} th{text-align:left;color:var(--muted);background:rgba(255,255,255,.03)}
    .surface{min-height:240px;border:1px dashed var(--border);border-radius:12px;padding:8px}
    .kpis{display:flex;gap:12px;flex-wrap:wrap}
    .kpi{background:rgba(255,255,255,.03);border:1px solid var(--border);padding:10px 12px;border-radius:12px;min-width:160px}
    .hstack{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .sep{height:1px;background:var(--border);margin:8px 0}
    @media (max-width: 900px){ .cols-6{grid-column:span 12} }
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="logo">AI</div>
    <div>
      <h1>Telco Churn Classifier — TensorFlow.js (Browser)</h1>
      <div class="muted">Client-side MLP; proper train/val/test; threshold tuned on validation; test metrics reported.</div>
    </div>
  </header>

  <div class="grid">
    <!-- 1) DATA -->
    <section class="card">
      <h2>1) Data</h2>
      <div class="hstack">
        <input id="fileCsv" type="file" accept=".csv,text/csv"/>
        <button class="btn" id="btnLoad">Load CSV</button>
        <span id="statusLoad" class="pill">Waiting for file…</span>
      </div>
      <div class="table-wrap" style="margin-top:8px"><div id="headPreview"></div></div>
    </section>

    <!-- 2) SETTINGS -->
    <section class="card cols-6">
      <h2>2) Settings</h2>
      <div class="hstack">
        <label>Test % <input id="testSplit" type="number" min="10" max="40" value="20"/></label>
        <label>Validation % (of train) <input id="valSplit" type="number" min="10" max="40" value="20"/></label>
        <label>Epochs <input id="epochs" type="number" min="5" max="200" value="40"/></label>
        <label>Batch <input id="batch" type="number" min="8" max="256" step="8" value="32"/></label>
        <label>Hidden
          <select id="layers">
            <option value="64,32" selected>64 → 32</option>
            <option value="32,16">32 → 16</option>
            <option value="128,64">128 → 64</option>
          </select>
        </label>
        <label>Patience <input id="patience" type="number" min="2" max="15" value="5" style="width:72px"/></label>
        <label><input id="balance" type="checkbox" checked/> Balance classes (oversample)</label>
        <label>Seed <input id="seed" type="text" value="42" style="width:72px"/></label>
        <button class="btn" id="btnTrain">Train</button>
        <span id="statusTrain" class="pill">Idle</span>
      </div>
      <div id="trainVis" class="surface" style="margin-top:8px"></div>
    </section>

    <!-- 3) EVALUATION -->
    <section class="card cols-6">
      <h2>3) Evaluation <span class="muted">— threshold from validation, metrics on test</span></h2>
      <div class="hstack">
        <label>Threshold <input id="thr" type="range" min="1" max="99" value="50"/></label>
        <span id="thrVal" class="pill">0.50</span>
        <button class="btn" id="btnBestThr">Best F1 (validation)</button>
        <button class="btn" id="btnSave">Save model</button>
      </div>
      <div class="kpis" id="kpisVal" style="margin-top:8px"></div>
      <div class="sep"></div>
      <div class="kpis" id="kpisTest"></div>
      <div class="sep"></div>
      <div class="table-wrap"><div id="thrSweep"></div></div>
      <div id="cm" class="surface" style="margin-top:8px"></div>
    </section>

    <!-- 4) PREDICT & EXPORT -->
    <section class="card">
      <h2>4) Predict & Export</h2>
      <div class="hstack">
        <button class="btn" id="btnPredict">Predict on full CSV</button>
        <button class="btn" id="btnDownloadPred">Download predictions (CSV)</button>
        <span id="statusPred" class="pill">No predictions yet</span>
      </div>
      <div class="table-wrap" style="margin-top:8px"><div id="tailPreview"></div></div>
    </section>

    <!-- NOTES -->
    <section class="card">
      <h2>Notes</h2>
      <ul>
        <li>Preprocessing: z-score of <code>tenure</code>, <code>MonthlyCharges</code>, <code>TotalCharges</code>; one-hot for categoricals.
            “No internet/phone service” → “No”. Empty <code>TotalCharges</code> with <code>tenure=0</code> → 0.</li>
        <li>Splits: train/validation/test. Threshold is selected on validation (max F1 by default); final metrics are on test.</li>
        <li>Model: MLP + BatchNorm + Dropout + L2; EarlyStopping (<code>patience</code>).</li>
        <li>Metrics: Accuracy, Precision, Recall, F1, ROC-AUC; confusion matrix; small threshold sweep table.</li>
      </ul>
    </section>
  </div>
</div>

<script>
  // ---------- small DOM helpers ----------
  const el=(t,p={},...kids)=>{const n=document.createElement(t);Object.assign(n,p);kids.forEach(k=>n.append(k?.nodeType?k:document.createTextNode(k??'')));return n};
  const clear=n=>{while(n.firstChild)n.removeChild(n.firstChild)};
  function table(container, rows, cols, caption){
    clear(container);
    if(caption) container.append(el('div',{className:'muted',style:'margin:6px 0'}, caption));
    const tbl=el('table'), thead=el('thead'), trh=el('tr');
    cols.forEach(c=>trh.appendChild(el('th',{},c))); thead.appendChild(trh); tbl.appendChild(thead);
    const tb=el('tbody');
    rows.forEach(r=>{const tr=el('tr'); cols.forEach(c=>tr.appendChild(el('td',{},String(r[c]??'')))); tb.appendChild(tr);});
    tbl.appendChild(tb); container.appendChild(tbl);
  }
  function toCSV(rows){
    if(!rows.length) return '';
    const cols=Object.keys(rows[0]);
    const esc=v=>(''+v).replaceAll('"','""');
    return [cols.join(','), ...rows.map(r=>cols.map(c=>`"${esc(r[c]??'')}"`).join(',')).join('\n')].join('\n');
  }

  // ---------- dataset cleaning ----------
  const NUM=['tenure','MonthlyCharges','TotalCharges'];
  const CAT=['gender','SeniorCitizen','Partner','Dependents','PhoneService','MultipleLines','InternetService','OnlineSecurity','OnlineBackup','DeviceProtection','TechSupport','StreamingTV','StreamingMovies','Contract','PaperlessBilling','PaymentMethod'];
  const DROP=['customerID'];

  function cleanRow(r){
    const rc={...r}; const trim=v=> typeof v==='string'? v.trim(): v;
    ['MultipleLines','OnlineSecurity','OnlineBackup','DeviceProtection','TechSupport','StreamingTV','StreamingMovies'].forEach(k=>{
      const v=trim(rc[k]); if(v==='No internet service'||v==='No phone service') rc[k]='No';
    });
    rc.tenure = Number(trim(rc.tenure));
    rc.MonthlyCharges = Number(trim(rc.MonthlyCharges));
    const t = trim(rc.TotalCharges); rc.TotalCharges = t===''||t==null? 0 : Number(t);
    rc.Churn = rc.Churn!=null? String(trim(rc.Churn)) : undefined;
    return rc;
  }

  function parseCSV(file){
    return new Promise((res,rej)=>{
      Papa.parse(file,{header:true,dynamicTyping:false,skipEmptyLines:true,complete:r=>{
        const rows=(r.data||[]).filter(x=>Object.values(x).some(v=>v!==''&&v!=null)).map(cleanRow);
        res({rows});
      },error:rej});
    });
  }

  // ---------- UI refs ----------
  const UI={
    file:()=>document.getElementById('fileCsv'), btnLoad:()=>document.getElementById('btnLoad'), statusLoad:()=>document.getElementById('statusLoad'),
    head:()=>document.getElementById('headPreview'),
    testSplit:()=>document.getElementById('testSplit'), valSplit:()=>document.getElementById('valSplit'),
    epochs:()=>document.getElementById('epochs'), batch:()=>document.getElementById('batch'), layers:()=>document.getElementById('layers'),
    patience:()=>document.getElementById('patience'), balance:()=>document.getElementById('balance'), seed:()=>document.getElementById('seed'),
    btnTrain:()=>document.getElementById('btnTrain'), statusTrain:()=>document.getElementById('statusTrain'), trainVis:()=>document.getElementById('trainVis'),
    thr:()=>document.getElementById('thr'), thrVal:()=>document.getElementById('thrVal'), btnBestThr:()=>document.getElementById('btnBestThr'),
    kpisVal:()=>document.getElementById('kpisVal'), kpisTest:()=>document.getElementById('kpisTest'), cm:()=>document.getElementById('cm'),
    thrSweep:()=>document.getElementById('thrSweep'),
    btnSave:()=>document.getElementById('btnSave'),
    btnPredict:()=>document.getElementById('btnPredict'), btnDownloadPred:()=>document.getElementById('btnDownloadPred'), statusPred:()=>document.getElementById('statusPred'),
    tail:()=>document.getElementById('tailPreview')
  };

  // ---------- state ----------
  const S={raw:[], cats:{}, mean:{}, std:{}, model:null, thr:0.5,
           Xtr:null,ytr:null, Xval:null,yval:null, Xte:null,yte:null,
           predsVal:null,predsTest:null, predRows:null };

  // ---------- helpers ----------
  function mulberry32(a){ return function(){ let t=a+=0x6D2B79F5; t=Math.imul(t^t>>>15, t|1); t^=t+Math.imul(t^t>>>7, t|61); return ((t^t>>>14)>>>0)/4294967296; } }
  function hashSeed(s){ try{ if(!s) return 42; let h=0; for(let i=0;i<s.length;i++){ h=(h*31+s.charCodeAt(i))|0; } return (h>>>0);}catch(e){return 42;} }
  function seededShuffle(arr, seed){ const rnd=mulberry32(seed>>>0); const a=arr.slice(); for(let i=a.length-1;i>0;i--){ const j=Math.floor(rnd()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; }

  function showHead(rows){ table(UI.head(), rows.slice(0,5), Object.keys(rows[0]||{}), 'Head (first 5 rows)'); }

  function fitPreprocess(trainRows){
    S.cats={}; for(const c of CAT){ S.cats[c]=[...new Set(trainRows.map(r=>String(r[c])))] }
    S.mean={}; S.std={};
    for(const c of NUM){
      const v=trainRows.map(r=>Number(r[c])); const n=v.length, m=v.reduce((s,x)=>s+x,0)/Math.max(1,n);
      const sd=Math.sqrt(v.reduce((s,x)=>s+(x-m)**2,0)/Math.max(1,n-1))||1; S.mean[c]=m; S.std[c]=sd;
    }
  }
  function rowToX(r){
    const x=[]; for(const c of NUM){ x.push( (Number(r[c])-S.mean[c])/S.std[c] ); }
    for(const c of CAT){ const cats=S.cats[c]; const val=String(r[c]); for(const u of cats) x.push(val===u?1:0); }
    return x;
  }
  function buildXY(rows){
    const X=[], y=[]; for(const r of rows){ X.push(rowToX(r)); y.push(r.Churn==='Yes'?1:0); }
    return {X:tf.tensor2d(X), y:tf.tensor2d(y,[y.length,1])};
  }
  function splitTrainValTest(rows, testPct, valPct, seed){
    const idx=[...rows.keys()], order=seededShuffle(idx, hashSeed(seed));
    const n=rows.length, nTest=Math.floor(n*testPct/100);
    const testIdx=order.slice(0,nTest), restIdx=order.slice(nTest);
    const nVal=Math.floor(restIdx.length*valPct/100);
    const valIdx=restIdx.slice(0,nVal), trainIdx=restIdx.slice(nVal);
    const take=(ids)=>ids.map(i=>rows[i]); return {train:take(trainIdx), val:take(valIdx), test:take(testIdx)};
  }
  function oversample(rows){
    const yes=rows.filter(r=>r.Churn==='Yes'), no=rows.filter(r=>r.Churn!=='Yes');
    if(yes.length===0||no.length===0) return rows;
    const ext=[]; while(yes.length+ext.length<no.length){ ext.push( yes[Math.floor(Math.random()*yes.length)] ); }
    return seededShuffle(rows.concat(ext), 123);
  }

  function cmMetrics(yTrue, yProb, thr){
    const n=yTrue.length; let tp=0,tn=0,fp=0,fn=0;
    for(let i=0;i<n;i++){ const p=yProb[i]>=thr?1:0; const t=yTrue[i];
      if(p===1&&t===1) tp++; else if(p===1&&t===0) fp++; else if(p===0&&t===1) fn++; else tn++; }
    const acc=(tp+tn)/n, prec=tp/(tp+fp||1), rec=tp/(tp+fn||1), f1=2*prec*rec/(prec+rec||1);
    return {tp,tn,fp,fn,acc,prec,rec,f1};
  }
  function rocAuc(yTrue, yProb){
    const pairs=yProb.map((p,i)=>({p, t:yTrue[i]})).sort((a,b)=>b.p-a.p);
    const P=yTrue.reduce((s,v)=>s+(v?1:0),0), N=yTrue.length-P;
    let tp=0, fp=0, prev=-Infinity; const pts=[{fpr:0,tpr:0}];
    for(const {p,t} of pairs){ if(p!==prev){ pts.push({fpr:fp/(N||1), tpr:tp/(P||1)}); prev=p; } if(t===1) tp++; else fp++; }
    pts.push({fpr:fp/(N||1), tpr:tp/(P||1)}); let auc=0;
    for(let i=1;i<pts.length;i++){ const x1=pts[i-1].fpr,x2=pts[i].fpr,y1=pts[i-1].tpr,y2=pts[i].tpr; auc+=(x2-x1)*(y1+y2)/2; }
    return auc;
  }
  function bestF1Threshold(yTrue,yProb){
    let best=0.5, bestF1=-1;
    for(let t=0.05;t<=0.95;t+=0.01){ const m=cmMetrics(yTrue,yProb,t); if(m.f1>bestF1){bestF1=m.f1; best=t;} }
    return {thr:best, f1:bestF1};
  }
  function renderKPIs(container, m, auc, title){
    const fmt=(x)=> (isFinite(x)? (x*100).toFixed(1)+'%' : '—'); clear(container);
    const items=[['Set',title||'Set'],['Accuracy',fmt(m.acc)],['Precision',fmt(m.prec)],['Recall',fmt(m.rec)],['F1',fmt(m.f1)],['ROC-AUC',fmt(auc)]];
    items.slice(1).forEach(([k,v])=>container.append(el('div',{className:'kpi'}, el('div',{className:'muted'},k), el('div',{style:'font-size:20px;font-weight:700'}, v))));
  }
  function renderCM(m){
    clear(UI.cm()); const tbl=el('table'), trh=el('tr');
    ['','Pred 0','Pred 1'].forEach(s=>trh.appendChild(el('th',{},s))); tbl.appendChild(el('thead',{},trh));
    const b=el('tbody');
    b.append(el('tr',{}, el('td',{},'True 0'), el('td',{}, String(m.tn)), el('td',{}, String(m.fp))));
    b.append(el('tr',{}, el('td',{},'True 1'), el('td',{}, String(m.fn)), el('td',{}, String(m.tp))));
    tbl.appendChild(b); UI.cm().append(tbl);
  }
  function renderThrSweep(y, p){
    const rows=[]; const grid=[0.30,0.40,0.50,0.60,0.70];
    for(const t of grid){ const m=cmMetrics(y,p,t); rows.push({Threshold:t.toFixed(2), Precision:(m.prec*100).toFixed(1)+'%', Recall:(m.rec*100).toFixed(1)+'%', F1:(m.f1*100).toFixed(1)+'%'}); }
    table(UI.thrSweep(), rows, ['Threshold','Precision','Recall','F1'], 'Threshold sweep (validation/test trade-off)');
  }

  // ---------- model ----------
  function buildModel(inputDim, layersSpec){
    const [u1,u2]=layersSpec.split(',').map(x=>parseInt(x.trim(),10));
    const l2r = tf.regularizers.l2({l2: 1e-4});
    const model=tf.sequential();
    model.add(tf.layers.dense({units:u1, activation:'relu', inputShape:[inputDim], kernelRegularizer:l2r}));
    model.add(tf.layers.batchNormalization());
    model.add(tf.layers.dropout({rate:0.25}));
    model.add(tf.layers.dense({units:u2, activation:'relu', kernelRegularizer:l2r}));
    model.add(tf.layers.dropout({rate:0.15}));
    model.add(tf.layers.dense({units:1, activation:'sigmoid'}));
    model.compile({optimizer:tf.train.adam(0.001), loss:'binaryCrossentropy', metrics:['accuracy']});
    return model;
  }

  // ---------- events ----------
  UI.btnLoad().addEventListener('click', async()=>{
    const f=UI.file().files[0]; if(!f){ UI.statusLoad().textContent='Please select CSV'; return; }
    UI.statusLoad().textContent='Parsing…';
    const {rows}=await parseCSV(f); S.raw=rows;
    UI.statusLoad().textContent=`Loaded ✓ (${rows.length} rows)`;
    showHead(rows);
  });

  UI.thr().addEventListener('input', ()=>{
    S.thr = Number(UI.thr().value)/100; UI.thrVal().textContent=S.thr.toFixed(2);
    if(!S.predsTest || !S.yte) return;
    const mT=cmMetrics(S.yte, S.predsTest, S.thr); const aucT=rocAuc(S.yte, S.predsTest);
    renderKPIs(UI.kpisTest(), mT, aucT, 'Test'); renderCM(mT);
  });

  UI.btnTrain().addEventListener('click', async()=>{
    if(S.raw.length===0){ alert('Load CSV first'); return; }
    UI.statusTrain().textContent='Preparing…';

    const seedStr=UI.seed().value||'42';
    const {train, val, test}=splitTrainValTest(S.raw, Number(UI.testSplit().value), Number(UI.valSplit().value), seedStr);
    const trainBalanced = UI.balance().checked ? oversample(train) : train;

    fitPreprocess(trainBalanced);
    const XYtr=buildXY(trainBalanced), XYval=buildXY(val), XYte=buildXY(test);
    S.Xtr=XYtr.X; S.ytr=XYtr.y;
    S.Xval=XYval.X; S.yval=Array.from(await XYval.y.data()).map(v=>Number(v));
    S.Xte=XYte.X;  S.yte =Array.from(await XYte.y.data()).map(v=>Number(v));

    const inputDim=S.Xtr.shape[1];
    S.model=buildModel(inputDim, UI.layers().value);

    // EarlyStopping (val_loss) with patience
    const patience = Number(UI.patience().value)||5;
    let best = {loss: Number.POSITIVE_INFINITY, epoch: -1};
    const earlyStop = {
      onEpochEnd: async (epoch, logs)=>{
        const vl = logs.val_loss ?? Number.POSITIVE_INFINITY;
        if (vl < best.loss - 1e-6){ best = {loss: vl, epoch}; }
        if (epoch - best.epoch >= patience){ S.model.stopTraining = true; }
      }
    };

    UI.statusTrain().textContent='Training…';
    const surface={name:'Training', tab:'Charts'};
    await S.model.fit(S.Xtr, S.ytr, {
      epochs:Number(UI.epochs().value),
      batchSize:Number(UI.batch().value),
      shuffle:true,
      validationData:[S.Xval, tf.tensor2d(S.yval,[S.yval.length,1])],
      callbacks: [tfvis.show.fitCallbacks(surface, ['loss','val_loss','acc','val_acc'], {callbacks:['onEpochEnd']}), earlyStop]
    });
    UI.statusTrain().textContent='Trained ✓';

    S.predsVal = Array.from(await S.model.predict(S.Xval).data());
    S.predsTest = Array.from(await S.model.predict(S.Xte).data());

    const b=bestF1Threshold(S.yval, S.predsVal);
    S.thr=b.thr; UI.thr().value = Math.round(S.thr*100); UI.thrVal().textContent=S.thr.toFixed(2);

    const mV=cmMetrics(S.yval, S.predsVal, S.thr), aucV=rocAuc(S.yval, S.predsVal);
    const mT=cmMetrics(S.yte,  S.predsTest, S.thr), aucT=rocAuc(S.yte,  S.predsTest);

    renderKPIs(UI.kpisVal(),  mV, aucV, 'Validation');
    renderKPIs(UI.kpisTest(), mT, aucT, 'Test');
    renderThrSweep(S.yval, S.predsVal);
    renderCM(mT);

    UI.statusPred().textContent='Ready to predict on full CSV';
  });

  UI.btnBestThr().addEventListener('click', ()=>{
    if(!S.predsVal){ return; }
    const b=bestF1Threshold(S.yval, S.predsVal);
    S.thr=b.thr; UI.thr().value = Math.round(S.thr*100); UI.thrVal().textContent=S.thr.toFixed(2);
    const mT=cmMetrics(S.yte, S.predsTest, S.thr); const aucT=rocAuc(S.yte, S.predsTest);
    renderKPIs(UI.kpisTest(), mT, aucT, 'Test'); renderCM(mT);
    const mV=cmMetrics(S.yval, S.predsVal, S.thr); const aucV=rocAuc(S.yval, S.predsVal);
    renderKPIs(UI.kpisVal(), mV, aucV, 'Validation');
  });

  UI.btnPredict().addEventListener('click', async()=>{
    if(!S.model){ alert('Train the model first'); return; }
    const out=[]; for(const r of S.raw){
      const p=await tf.tidy(()=> S.model.predict(tf.tensor2d([rowToX(r)])).dataSync()[0] );
      out.push({customerID:r.customerID, prob:p, pred:(p>=S.thr?'Yes':'No')});
    }
    S.predRows = S.raw.map((r,i)=> ({...r, Pred_Prob: out[i].prob.toFixed(4), Pred_Label: out[i].pred}) );
    UI.statusPred().textContent=`Predicted ✓ (${S.predRows.length} rows)`;
    table(UI.tail(), S.predRows.slice(-5), Object.keys(S.predRows[0]), 'Tail (last 5 rows with predictions)');
  });

  UI.btnDownloadPred().addEventListener('click', ()=>{
    if(!S.predRows){ alert('No predictions yet'); return; }
    const csv=toCSV(S.predRows);
    const blob=new Blob([csv], {type:'text/csv'});
    const url=URL.createObjectURL(blob); const a=document.createElement('a');
    a.href=url; a.download='telco_churn_predictions.csv'; document.body.appendChild(a); a.click();
    URL.revokeObjectURL(url); a.remove();
  });

  UI.btnSave().addEventListener('click', async()=>{
    if(!S.model){ alert('Train the model first'); return; }
    const prep={cats:S.cats, mean:S.mean, std:S.std, thr:S.thr, num:NUM, cat:CAT, drop:DROP};
    const blob=new Blob([JSON.stringify(prep,null,2)],{type:'application/json'});
    const url=URL.createObjectURL(blob); const a=document.createElement('a');
    a.href=url; a.download='preprocessing.json'; document.body.appendChild(a); a.click(); URL.revokeObjectURL(url); a.remove();
    await S.model.save('downloads://telco_churn_tfjs_model');
  });
</script>
</body>
</html>
