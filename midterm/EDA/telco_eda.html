<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Telco Customer Churn — EDA (Single HTML, File Upload)</title>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.20.0/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-vis@1.5.1/dist/tfjs-vis.umd.min.js"></script>
  <style>
    :root{--bg:#0f1221;--card:#171a2f;--text:#e7ebff;--muted:#a8b0d9;--border:#2a2f52}
    *{box-sizing:border-box} body{margin:0;background:radial-gradient(1200px 800px at 20% -10%,#1a2050,var(--bg));color:var(--text);font:15px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
    .wrap{max-width:1200px;margin:24px auto 80px;padding:0 16px} header{display:flex;gap:16px;align-items:center;margin-bottom:16px}
    .logo{width:42px;height:42px;border-radius:12px;background:linear-gradient(135deg,#5aa9ff,#a855f7);color:#fff;display:flex;align-items:center;justify-content:center;font-weight:800}
    h1{margin:0;font-size:20px}.hint{color:var(--muted);margin-top:-2px}
    .grid{display:grid;gap:16px;grid-template-columns:repeat(12,1fr)}
    .card{grid-column:span 12;background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,.01));border:1px solid var(--border);border-radius:16px;padding:16px}
    .card h2{margin:0 0 10px;font-size:16px}.sub{color:var(--muted);margin:2px 0 10px}
    .cols-6{grid-column:span 6}.cols-4{grid-column:span 4}.cols-8{grid-column:span 8}
    .pill{display:inline-block;padding:4px 10px;border-radius:999px;border:1px solid var(--border);color:var(--muted);background:rgba(255,255,255,.03);margin:0 6px 6px 0}
    table{width:100%;border-collapse:collapse;border:1px solid var(--border);border-radius:10px;overflow:hidden}
    th,td{padding:8px 10px;border-bottom:1px solid var(--border)} th{text-align:left;color:var(--muted);background:rgba(255,255,255,.03)} tr:last-child td{border-bottom:none}
    .surfaces{display:grid;grid-template-columns:repeat(2,1fr);gap:12px} .surface{min-height:260px;border:1px dashed var(--border);border-radius:12px;padding:8px}
    .btn{appearance:none;border:1px solid var(--border);color:var(--text);background:rgba(255,255,255,.03);padding:8px 12px;border-radius:12px;cursor:pointer}
    .bullets{background:rgba(255,255,255,.03);border:1px solid var(--border);border-radius:12px;padding:10px;margin-top:8px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="logo">AI</div>
      <div>
        <h1>Telco Customer Churn — Exploratory Data Analysis</h1>
        <div class="hint">Upload the CSV (IBM Telco Churn). Fully client-side.</div>
      </div>
    </header>

    <div class="grid">
      <section class="card cols-12">
        <h2>1) Data Load</h2>
        <div class="sub">Pick the CSV, then click Load.</div>
        <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap;">
          <input id="fileInput" type="file" accept=".csv,text/csv"/>
          <button class="btn" id="loadBtn">Load CSV</button>
          <span id="loadStatus" class="pill">Waiting for file…</span>
        </div>
      </section>

      <section class="card cols-6">
        <h2>2) Shapes & Columns</h2>
        <div id="shapes"></div>
        <div id="columnsPills" style="margin-top:8px;"></div>
      </section>

      <section class="card cols-6">
        <h2>3) Head (first 5 rows)</h2>
        <div id="headTable"></div>
      </section>

      <section class="card cols-12">
        <h2>4) Missing Values</h2>
        <div id="missingTable"></div>
      </section>

      <section class="card cols-12">
        <h2>5) Churn Insights</h2>
        <div class="sub">Class balance; churn by Contract, InternetService, Tenure (bins)</div>
        <div class="surfaces">
          <div class="surface" id="chartBalance"></div>
          <div class="surface" id="chartContract"></div>
          <div class="surface" id="chartInternet"></div>
          <div class="surface" id="chartTenure"></div>
        </div>
        <div style="margin-top:10px;">
          <div id="tableContract" style="margin-top:8px;"></div>
          <div id="tableInternet" style="margin-top:8px;"></div>
          <div id="tableTenure" style="margin-top:8px;"></div>
        </div>
      </section>

      <section class="card cols-12">
        <h2>6) Auto Summary & Export</h2>
        <div class="sub">Bullets + JSON export</div>
        <div id="summaryBullets" class="bullets"></div>
        <div style="margin-top:8px;display:flex;gap:12px;align-items:center;flex-wrap:wrap;">
          <button class="btn" id="downloadJson">Download EDA summary (JSON)</button>
        </div>
      </section>
    </div>
  </div>

  <script>
    const el=(t,p={},...kids)=>{const n=document.createElement(t);Object.assign(n,p);kids.forEach(k=>n.append(k?.nodeType?k:document.createTextNode(k??'')));return n};
    const clear=n=>{while(n.firstChild)n.removeChild(n.firstChild)};
    const fmtPct=x=>(isFinite(x)?(x*100).toFixed(1)+'%':'—');

    function table(container, rows, cols){
      clear(container);
      const tbl=el('table'), thead=el('thead'), trh=el('tr');
      cols.forEach(c=>trh.appendChild(el('th',{},c))); thead.appendChild(trh); tbl.appendChild(thead);
      const tb=el('tbody');
      rows.forEach(r=>{const tr=el('tr'); cols.forEach(c=>tr.appendChild(el('td',{},String(r[c]??'')))); tb.appendChild(tr);});
      tbl.appendChild(tb); container.appendChild(tbl);
    }
    function pills(container, items){ clear(container); items.forEach(s=>container.appendChild(el('span',{className:'pill'},s))); }

    function groupMean(rows, groupCol, targetCol){
      const agg=new Map();
      for(const r of rows){
        const g=(r[groupCol]==null||r[groupCol]==='')?'(missing)':r[groupCol];
        const y=String(r[targetCol])==='Yes'?1:(String(r[targetCol])==='No'?0:Number(r[targetCol]));
        if(!isFinite(y)) continue;
        const o=agg.get(g)||{n:0,s:0}; o.n+=1; o.s+=y; agg.set(g,o);
      }
      return Array.from(agg.entries()).map(([g,o])=>({group:g,n:o.n,rate:o.s/o.n}));
    }
    function missingByColumn(rows, cols){
      const out=[];
      for(const c of cols){
        let miss=0;
        for(const r of rows){ const v=r[c]; if(v===null||v===undefined||v==='') miss++; }
        out.push({column:c, missing:miss, percent: rows.length? miss/rows.length : 0});
      }
      return out.sort((a,b)=>b.percent-a.percent);
    }
    function renderBar(container, dataXY, opts={}){
      const data=dataXY.map(d=>({index:String(d.x), value:Number(d.y)}));
      const options=Object.assign({xLabel:'Category', yLabel:'Value', yAxisDomain:[0,1], height:260}, opts);
      clear(container); tfvis.render.barchart(container, data, options);
    }
    function tenureBin(t){ if(!isFinite(t)) return '(missing)'; if(t<6) return '0–5'; if(t<12) return '6–11'; if(t<24) return '12–23'; if(t<36) return '24–35'; if(t<60) return '36–59'; return '60+'; }

    function parseCsvFile(file){
      return new Promise((res,rej)=>{
        Papa.parse(file,{header:true,dynamicTyping:false,skipEmptyLines:true,quoteChar:'"',escapeChar:'"',
          complete:r=>{
            let data=(r.data||[]).filter(row=>Object.values(row).some(v=>v!==''&&v!=null));
            data=data.map(row=>{
              const rc={...row};
              const norm=(v)=> typeof v==='string' ? v.trim() : v;
              rc.TotalCharges = (()=>{const t=norm(rc.TotalCharges); const num=Number(t); return isFinite(num)?num:null;})();
              rc.MonthlyCharges = Number(norm(rc.MonthlyCharges));
              rc.tenure = Number(norm(rc.tenure));
              const collapse=['MultipleLines','OnlineSecurity','OnlineBackup','DeviceProtection','TechSupport','StreamingTV','StreamingMovies'];
              collapse.forEach(k=>{ const v=norm(rc[k]); if(v==='No internet service'||v==='No phone service') rc[k]='No'; });
              if(rc.Churn!=null) rc.Churn = String(norm(rc.Churn));
              return rc;
            });
            const columns=r.meta?.fields || Object.keys(data[0]||{});
            res({data,columns});
          }, error:rej
        });
      });
    }

    const UI={
      file:()=>document.getElementById('fileInput'),
      loadBtn:()=>document.getElementById('loadBtn'),
      loadStatus:()=>document.getElementById('loadStatus'),
      shapes:()=>document.getElementById('shapes'),
      columnsPills:()=>document.getElementById('columnsPills'),
      headTable:()=>document.getElementById('headTable'),
      missingTable:()=>document.getElementById('missingTable'),
      chartBalance:()=>document.getElementById('chartBalance'),
      chartContract:()=>document.getElementById('chartContract'),
      chartInternet:()=>document.getElementById('chartInternet'),
      chartTenure:()=>document.getElementById('chartTenure'),
      tableContract:()=>document.getElementById('tableContract'),
      tableInternet:()=>document.getElementById('tableInternet'),
      tableTenure:()=>document.getElementById('tableTenure'),
      summary:()=>document.getElementById('summaryBullets'),
      downloadJson:()=>document.getElementById('downloadJson')
    };

    let DATA=null, SUMMARY=null;

    function makeSummary(data){
      const n=data.length;
      const pos=data.filter(r=>r.Churn==='Yes').length;
      const overall=pos/n;

      const contract=groupMean(data,'Contract','Churn');
      const internet=groupMean(data,'InternetService','Churn');
      const binned=data.map(r=>({TenureBin:tenureBin(Number(r.tenure)),Churn:r.Churn}));
      const tenure=groupMean(binned,'TenureBin','Churn');

      function best(arr, dir=1){
        return arr.reduce((best,cur)=> (best==null || (dir>0?cur.rate>best.rate:cur.rate<best.rate))?cur:best, null);
      }
      const byContractMax=best(contract,1), byContractMin=best(contract,-1);
      const byInternetMax=best(internet,1), byInternetMin=best(internet,-1);
      const byTenureMax=best(tenure,1), byTenureMin=best(tenure,-1);

      return {
        rows:n, churn_rate:overall,
        contract:{max:byContractMax, min:byContractMin},
        internet:{max:byInternetMax, min:byInternetMin},
        tenure:{max:byTenureMax, min:byTenureMin}
      };
    }

    function renderSummary(sum){
      const b=UI.summary(); clear(b);
      const bullets=[
        `Overall churn rate: ${fmtPct(sum.churn_rate)} (${sum.rows} customers).`,
        `Highest churn by Contract: ${sum.contract.max.group} — ${fmtPct(sum.contract.max.rate)} (n=${sum.contract.max.n}).`,
        `Lowest churn by Contract: ${sum.contract.min.group} — ${fmtPct(sum.contract.min.rate)} (n=${sum.contract.min.n}).`,
        `Highest churn by InternetService: ${sum.internet.max.group} — ${fmtPct(sum.internet.max.rate)} (n=${sum.internet.max.n}).`,
        `Lowest churn by InternetService: ${sum.internet.min.group} — ${fmtPct(sum.internet.min.rate)} (n=${sum.internet.min.n}).`,
        `Churn vs Tenure: highest in ${sum.tenure.max.group} — ${fmtPct(sum.tenure.max.rate)}; lowest in ${sum.tenure.min.group} — ${fmtPct(sum.tenure.min.rate)}.`
      ];
      bullets.forEach(t=>b.append(el('div',{},'• ',t)));
    }

    function downloadJSON(obj, name='eda_summary.json'){
      const s=JSON.stringify(obj,null,2);
      const blob=new Blob([s],{type:'application/json'});
      const url=URL.createObjectURL(blob);
      const a=document.createElement('a'); a.href=url; a.download=name; document.body.appendChild(a); a.click(); URL.revokeObjectURL(url); a.remove();
    }

    document.getElementById('loadBtn').addEventListener('click', async()=>{
      const file=UI.file().files[0];
      if(!file){ UI.loadStatus().textContent='Please select CSV'; return; }
      UI.loadStatus().textContent='Parsing…';
      try{
        const parsed=await parseCsvFile(file); DATA=parsed;
        UI.loadStatus().textContent='Loaded ✓';
        clear(UI.shapes()); UI.shapes().append(el('div',{},`rows: ${DATA.data.length}, columns: ${DATA.columns.length}`));
        pills(UI.columnsPills(), DATA.columns);
        table(UI.headTable(), DATA.data.slice(0,5), DATA.columns);
        const miss=missingByColumn(DATA.data, DATA.columns).map(o=>({Column:o.column, Missing:o.missing, Percent:fmtPct(o.percent)}));
        table(UI.missingTable(), miss, ['Column','Missing','Percent']);
        const n=DATA.data.length, pos=DATA.data.filter(r=>r.Churn==='Yes').length;
        renderBar(UI.chartBalance(), [{x:'No',y:(n-pos)/n},{x:'Yes',y:pos/n}], {xLabel:'Churn', yLabel:'Share', yAxisDomain:[0,1]});
        const byContract=groupMean(DATA.data,'Contract','Churn').map(o=>({x:String(o.group), y:o.rate}));
        renderBar(UI.chartContract(), byContract, {xLabel:'Contract', yLabel:'Churn rate', yAxisDomain:[0,1]});
        const byNet=groupMean(DATA.data,'InternetService','Churn').map(o=>({x:String(o.group), y:o.rate}));
        renderBar(UI.chartInternet(), byNet, {xLabel:'InternetService', yLabel:'Churn rate', yAxisDomain:[0,1]});
        const binned=DATA.data.map(r=>({TenureBin: tenureBin(Number(r.tenure)), Churn:r.Churn}));
        const byTen=groupMean(binned,'TenureBin','Churn').sort((a,b)=>a.group.localeCompare(b.group)).map(o=>({x:String(o.group), y:o.rate}));
        renderBar(UI.chartTenure(), byTen, {xLabel:'Tenure (months, bins)', yLabel:'Churn rate', yAxisDomain:[0,1]});
        const byContractTbl=groupMean(DATA.data,'Contract','Churn').map(o=>({Contract:String(o.group), Count:o.n, 'Churn rate':fmtPct(o.rate)}));
        table(UI.tableContract(), byContractTbl, ['Contract','Count','Churn rate']);
        const byNetTbl=groupMean(DATA.data,'InternetService','Churn').map(o=>({InternetService:String(o.group), Count:o.n, 'Churn rate':fmtPct(o.rate)}));
        table(UI.tableInternet(), byNetTbl, ['InternetService','Count','Churn rate']);
        const byTenTbl=groupMean(binned,'TenureBin','Churn').sort((a,b)=>a.group.localeCompare(b.group)).map(o=>({TenureBin:String(o.group), Count:o.n, 'Churn rate':fmtPct(o.rate)}));
        table(UI.tableTenure(), byTenTbl, ['TenureBin','Count','Churn rate']);
        SUMMARY = makeSummary(DATA.data);
        renderSummary(SUMMARY);
      }catch(err){
        console.error(err); UI.loadStatus().textContent='Error ❌'; alert('CSV parse error: '+err.message);
      }
    });

    document.getElementById('downloadJson').addEventListener('click', ()=>{
      if(!SUMMARY){ alert('Load CSV first.'); return; }
      downloadJSON(SUMMARY, 'telco_eda_summary.json');
    });
  </script>
</body>
</html>
